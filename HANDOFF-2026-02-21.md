# Flamora iOS â€” å¯¹æ¥æ–‡æ¡£ 2026-02-21

## é¡¹ç›®åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | ä¿¡æ¯ |
|------|------|
| **é¡¹ç›®å** | Flamora â€” FIRE ç†è´¢ iOS App |
| **å¹³å°** | iOS (SwiftUI) |
| **Git ä»“åº“** | https://github.com/franklqx/Flamora |
| **æœ¬åœ°è·¯å¾„** | `~/Documents/GitHub/Flamora/Flamora/`ï¼ˆæ³¨æ„ï¼šå†…éƒ¨æ˜¯åµŒå¥— git repoï¼ŒçœŸå®ä»“åº“åœ¨ `Flamora/Flamora/`ï¼‰ |
| **æœ€æ–° commit** | `0b2f260` fix: replace fullScreenCover with UIWindow for Plaid Link |

---

## ç¯å¢ƒé…ç½®é€ŸæŸ¥

### åç«¯ï¼šSupabase
- **Project URLï¼š** `https://vnyalfpmopvoswccewju.supabase.co`
- **æ‰€æœ‰ API è°ƒç”¨**é€šè¿‡ `APIService.swift`ï¼ŒBearer token é‰´æƒ
- **Edge Functionsï¼ˆå·²éƒ¨ç½²ï¼‰ï¼š**
  - `create-link-token` â€” ç”Ÿæˆ Plaid link token
  - `exchange-public-token` â€” äº¤æ¢ Plaid public tokenï¼Œå­˜å‚¨ access token
  - `get-user-profile` â€” è·å–ç”¨æˆ·èµ„æ–™ï¼ˆå«é“¶è¡Œè¿æ¥çŠ¶æ€ï¼‰
  - `disconnect-bank` â€” æ–­å¼€é“¶è¡Œè¿æ¥
  - `get-cashflow`ã€`get-investments`ã€`get-journey` â€” æ•°æ®æŸ¥è¯¢

### ç¬¬ä¸‰æ–¹ SDK
| SDK | ç”¨é€” | é…ç½® |
|-----|------|------|
| Supabase Swift SDK | Auth + functions.invoke | å·²é›†æˆï¼Œ`SupabaseManager.swift` |
| RevenueCat | è®¢é˜…ç®¡ç† | API Key: `test_CTvrBqscaqNCibGtSMxCUeXbmae`ï¼ŒEntitlement: `Flamora Pro` |
| Plaid Link iOS | é“¶è¡Œè¿æ¥ | Sandbox ç¯å¢ƒï¼Œé€šè¿‡ Edge Function è·å– link token |

### Plaid Sandbox æµ‹è¯•è´¦æˆ·
- é“¶è¡Œï¼š**First Platypus Bank** (`ins_109508`)
- ç”¨æˆ·åï¼š`user_good`ï¼Œå¯†ç ï¼šä»»æ„éç©ºå­—ç¬¦ä¸²

### æ¶æ„æ¨¡å¼
- `@Observable` patternï¼ˆé `ObservableObject`ï¼‰
- æ³¨å…¥ï¼š`.environment(obj)` / è¯»å–ï¼š`@Environment(T.self)`
- UUID ä¼ åç«¯æ—¶å¿…é¡» `.lowercased()`

---

## å½“å‰é¡¹ç›®çŠ¶æ€ï¼ˆæˆªè‡³ 2026-02-21ï¼‰

### å·²å®ŒæˆåŠŸèƒ½
- [x] Authï¼ˆç™»å½•/æ³¨å†Œ/é€€å‡ºï¼‰ â€” `SupabaseManager.swift`
- [x] Onboarding å…¨æµç¨‹ï¼ˆ8 æ­¥ï¼‰
- [x] RevenueCat è®¢é˜… + Paywall â€” `SubscriptionManager.swift`
- [x] Plaid Link SDK é›†æˆï¼ˆé“¶è¡Œè¿æ¥æµç¨‹ï¼‰
- [x] ä¸‰ä¸ªä¸» Tab åˆå§‹çŠ¶æ€ï¼ˆæœªè¿æ¥ CTAï¼‰
- [x] ä¸‰ä¸ªä¸» Tab å·²è¿æ¥çŠ¶æ€ï¼ˆçœŸå® API æ•°æ®ï¼‰
- [x] Settingsï¼ˆè®¢é˜…ç®¡ç† + æ–­å¼€é“¶è¡Œ + é€€å‡ºç™»å½•ï¼‰
- [x] Splash Screen

---

## P0 Bug ä¿®å¤è¿›å±•ï¼ˆå…³é”®é˜»å¡ï¼‰

### Bug æè¿°
**Plaid Link è¿æ¥æˆåŠŸåï¼Œè¿”å›ä¸»ç•Œé¢ï¼Œæ‰€æœ‰ Tab é¡µé¢çš„æŒ‰é’®æ— æ³•ç‚¹å‡»ï¼ˆè§¦æ‘¸äº‹ä»¶è¢«æ‹¦æˆªï¼‰ã€‚**

### å·²å°è¯•æ–¹æ¡ˆï¼ˆå…¨éƒ¨å¤±è´¥æˆ–éƒ¨åˆ†æœ‰æ•ˆï¼‰

| æ–¹æ¡ˆ | ç»“æœ |
|------|------|
| ä¿®æ”¹ `fullScreenCover` dismiss é€»è¾‘ï¼ˆpendingLinkToken æ—¶æœºï¼‰ | å¤±è´¥ |
| `@State showPlaidLink` + `capturedLinkToken` ç‹¬ç«‹å˜é‡ | å¯¼è‡´ç™½å± |
| `fullScreenCover(item:)` + `PlaidLinkItem` Identifiable wrapper | å¤±è´¥ |
| `PlaidLinkRepresentable` ä¸­å…ˆ dismiss linkVC å†è°ƒå›è°ƒ | å¤±è´¥ |
| `findLinkViewController()` éå† parent chain | å¤±è´¥ |
| **UIWindow overlayï¼ˆå½“å‰æ–¹æ¡ˆï¼‰** | éƒ¨åˆ†æœ‰æ•ˆï¼Œè§ä¸‹ |

### å½“å‰æ–¹æ¡ˆï¼šUIWindow Overlayï¼ˆ`PlaidLinkPresenter.swift`ï¼‰

**åŸç†ï¼š** ä¸ä½¿ç”¨ SwiftUI `fullScreenCover`ï¼Œæ”¹ç”¨ç‹¬ç«‹ `UIWindow`ï¼ˆ`windowLevel = .alert + 1`ï¼‰å‘ˆç° Plaid Linkï¼Œè¿æ¥å®Œæˆåé”€æ¯è¯¥ windowã€‚

**æœ¬æ¬¡æ”¹åŠ¨æ–‡ä»¶ï¼š**
- **æ–°å»ºï¼š** `Flamora/Services/PlaidLinkPresenter.swift` â€” UIWindow overlay æ ¸å¿ƒé€»è¾‘
- **ä¿®æ”¹ï¼š** `Flamora/Services/PlaidManager.swift` â€” ç§»é™¤ `pendingLinkToken`ï¼Œç›´æ¥è°ƒç”¨ `PlaidLinkPresenter.shared.present(...)`
- **ä¿®æ”¹ï¼š** `Flamora/Flamora app/ContentView.swift` â€” ç§»é™¤ Plaid fullScreenCover ç›¸å…³ä»£ç ï¼Œç§»é™¤ `@Environment(PlaidManager.self)`

**å¯åˆ é™¤æ–‡ä»¶ï¼ˆå·²æ— å¼•ç”¨ï¼‰ï¼š**
- `Flamora/View/Shared/PlaidLinkRepresentable.swift` â€” æ—§çš„ `UIViewControllerRepresentable` æ–¹æ¡ˆï¼Œç°å·²åºŸå¼ƒ

### è¯Šæ–­å‘ç°çš„çœŸå®æ ¹å› 

é€šè¿‡åœ¨ `destroyWindow()` ä¸­æ‰“å°æ‰€æœ‰ window ä¿¡æ¯ï¼Œå‘ç°ï¼š

```
â–¸ UIWindow              level=0     hidden=false  interaction=true   key=true   â† ä¸» App window âœ…
â–¸ UIWindow              level=2001  hidden=true   interaction=false  key=false  â† æˆ‘ä»¬çš„ overlayï¼ˆå·²éšè—ï¼‰âœ…
â–¸ UITextEffectsWindow   level=2002  hidden=false  interaction=true   key=false  â† çœŸæ­£çš„æ‹¦æˆªè€… âŒ
```

**æ ¹æœ¬åŸå› ï¼š**
Plaid Link å†…éƒ¨ä½¿ç”¨ WKWebView æ¸²æŸ“ç•Œé¢ã€‚WKWebView åœ¨ iOS ä¸­ä½¿ç”¨ `UITextEffectsWindow`ï¼ˆlevel 2002ï¼‰å¤„ç†æ–‡å­—é€‰ä¸­ã€æ”¾å¤§é•œç­‰æ•ˆæœã€‚å½“ WKWebView è¢« dismiss æ—¶ï¼ŒUIKit **æ²¡æœ‰è‡ªåŠ¨éšè—**è¯¥ windowï¼Œå¯¼è‡´å…¶ä»¥ `hidden=false + interaction=true` çŠ¶æ€åœç•™åœ¨æœ€é¡¶å±‚ï¼Œæ‹¦æˆªæ‰€æœ‰è§¦æ‘¸äº‹ä»¶ã€‚**è¿™æ˜¯ Plaid SDK çš„æ¸…ç†ç–æ¼ï¼Œä¸æˆ‘ä»¬ç”¨ fullScreenCover è¿˜æ˜¯ UIWindow æ— å…³ã€‚**

### å½“å‰çŠ¶æ€

`destroyWindow()` ä¸­å·²åŠ å…¥å¦‚ä¸‹ä¿®å¤ï¼š

```swift
for w in scene.windows where w !== win && !w.isHidden && w.windowLevel > .normal {
    print("ğŸ”— Hiding elevated window: \(type(of: w)) level=\(Int(w.windowLevel.rawValue))")
    w.isHidden = true
}
```

ä½†æµ‹è¯•ç»“æœæ˜¾ç¤º tab **ä»ç„¶æ— æ³•ç‚¹å‡»**ï¼Œè¯´æ˜ï¼š
1. `UITextEffectsWindow` è¢«éšè—åï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»– window æˆ– view åœ¨æ‹¦æˆªè§¦æ‘¸
2. æˆ–è€… `UITextEffectsWindow` çš„éšè—æ²¡æœ‰ç”Ÿæ•ˆï¼ˆç³»ç»Ÿå¯èƒ½è¦†ç›–äº†æˆ‘ä»¬çš„æ“ä½œï¼‰

---

## ä¸‹ä¸€æ­¥æ’æŸ¥æ–¹å‘ï¼ˆP0 ç»§ç»­ï¼‰

### æ–¹å‘ä¸€ï¼šéªŒè¯ UITextEffectsWindow æ˜¯å¦çœŸçš„è¢«éšè—

åœ¨ `destroyWindow()` ç»“æŸåï¼Œå¢åŠ å»¶è¿Ÿæ‰“å°ï¼Œç¡®è®¤ `UITextEffectsWindow` çš„çŠ¶æ€ï¼š

```swift
DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
    for w in UIApplication.shared.connectedScenes
        .compactMap({ $0 as? UIWindowScene })
        .flatMap({ $0.windows }) {
        print("  [0.5s later] \(type(of: w)) hidden=\(w.isHidden) interaction=\(w.isUserInteractionEnabled)")
    }
}
```

### æ–¹å‘äºŒï¼šéå† view å±‚çº§æŸ¥æ‰¾æ‹¦æˆªè€…

è§¦æ‘¸æ‹¦æˆªä¸ä¸€å®šæ¥è‡ª windowï¼Œä¹Ÿå¯èƒ½æ˜¯æŸä¸ª view çš„ `isUserInteractionEnabled`ã€`frame` è¦†ç›–ã€æˆ– `gestureRecognizer` å¯¼è‡´ã€‚

å¯ç”¨ `Xcode â†’ Debug â†’ View Hierarchy`ï¼ˆæˆ– LLDB `po [UIWindow keyWindow] recursiveDescription`ï¼‰åœ¨è¿æ¥æˆåŠŸåæˆªå›¾ view å±‚çº§ï¼ŒæŸ¥æ‰¾è¦†ç›–æ•´ä¸ªå±å¹•çš„é€æ˜ viewã€‚

### æ–¹å‘ä¸‰ï¼šæ£€æŸ¥ WKWebView first responder çŠ¶æ€

Plaid WKWebView dismiss æ—¶å¯èƒ½æ²¡æœ‰ resign first responderã€‚å°è¯•åœ¨ `tearDown()` å¼€å§‹æ—¶ï¼š

```swift
UIApplication.shared.sendAction(#selector(UIResponder.resignFirstResponder), to: nil, from: nil, for: nil)
```

### æ–¹å‘å››ï¼šè€ƒè™‘å®Œå…¨ä¸åŒçš„ Plaid å‘ˆç°æ–¹å¼

ä½¿ç”¨ `SFSafariViewController` æ–¹å¼å‘ˆç° Plaidï¼ˆå¦‚æœ Plaid æ”¯æŒ OAuth æ¨¡å¼ï¼‰ï¼Œé¿å… WKWebView çš„å‰¯ä½œç”¨ã€‚

---

## å¾…å®Œæˆä»»åŠ¡ä¼˜å…ˆçº§

### P0 â€” å½“å‰é˜»å¡
- [ ] **ä¿®å¤ Plaid Link è¿æ¥åè§¦æ‘¸è¢«æ‹¦æˆª**ï¼ˆè§ä¸Šæ–¹æ’æŸ¥æ–¹å‘ï¼‰

### P1 â€” æ ¸å¿ƒåŠŸèƒ½
- [ ] Journey Tabï¼šFIRE è¿›åº¦è®¡ç®—ã€å‡€èµ„äº§å›¾è¡¨ï¼ˆçœŸå®æ•°æ® API å·²æ¥é€šï¼‰
- [ ] Cashflow Tabï¼šæ”¯å‡ºåˆ†ç±»å±•ç¤ºï¼ˆçœŸå®æ•°æ® API å·²æ¥é€šï¼‰
- [ ] Investment Tabï¼šæŒä»“è¯¦æƒ…ï¼ˆçœŸå®æ•°æ® API å·²æ¥é€šï¼‰
- [ ] ç”¨æˆ·èµ„æ–™é¡µï¼ˆå§“åã€å¤´åƒã€å¹´é¾„ç­‰ï¼‰

### P2 â€” ä½“éªŒä¼˜åŒ–
- [ ] Loading/Skeleton çŠ¶æ€ç»Ÿä¸€å¤„ç†
- [ ] é”™è¯¯çŠ¶æ€ UIï¼ˆç½‘ç»œå¤±è´¥ã€API é”™è¯¯æç¤ºï¼‰
- [ ] Pull-to-refresh
- [ ] Haptic feedback

### P3 â€” ä¸Šæ¶å‡†å¤‡
- [ ] RevenueCat åˆ‡æ¢ä¸º Production API Key
- [ ] Plaid åˆ‡æ¢ä¸º Production ç¯å¢ƒ
- [ ] App Store Connect é…ç½®ï¼ˆæˆªå›¾ã€æè¿°ã€éšç§æ”¿ç­–ï¼‰
- [ ] TestFlight beta æµ‹è¯•

---

## å…³é”®æ–‡ä»¶è·¯å¾„é€ŸæŸ¥

```
Flamora/Flamora app/ContentView.swift       â€” æ ¹è§†å›¾ï¼ŒAuth è·¯ç”±ï¼ŒPaywall sheet
Flamora/Flamora app/Flamora_appApp.swift    â€” App å…¥å£ï¼Œç¯å¢ƒæ³¨å…¥
Flamora/Services/SupabaseManager.swift      â€” Auth + Supabase client
Flamora/Services/PlaidManager.swift         â€” Plaid è¿æ¥æµç¨‹ï¼ˆ@Observableï¼‰
Flamora/Services/PlaidLinkPresenter.swift   â€” UIWindow overlay å‘ˆç° Plaid Link
Flamora/Services/SubscriptionManager.swift  â€” RevenueCat è®¢é˜…çŠ¶æ€ï¼ˆ@Observableï¼‰
Flamora/Services/APIService.swift           â€” æ‰€æœ‰ API è°ƒç”¨ï¼ˆBearer tokenï¼‰
Flamora/View/MainTabView.swift              â€” ä¸‰ Tab ç»“æ„
Flamora/View/Settings/SettingsView.swift    â€” è®¾ç½®é¡µ
Flamora/View/Shared/PaywallSheet.swift      â€” å…¨å±€ Paywall
```

---

## æ³¨æ„äº‹é¡¹

1. **åµŒå¥— git ä»“åº“**ï¼šæœ¬åœ° `~/Documents/GitHub/Flamora/` æ˜¯å¤–å±‚ repoï¼ˆè€ç»“æ„ï¼‰ï¼Œ`~/Documents/GitHub/Flamora/Flamora/` æ‰æ˜¯çœŸå® Xcode é¡¹ç›®å’Œ git ä»“åº“ï¼Œæ‰€æœ‰ git æ“ä½œåœ¨å†…å±‚æ‰§è¡Œã€‚
2. **æ–°å»º Swift æ–‡ä»¶éœ€æ‰‹åŠ¨æ·»åŠ åˆ° Xcode target**ï¼š`PlaidLinkPresenter.swift` ç­‰é€šè¿‡ Claude Code ç”Ÿæˆçš„æ–‡ä»¶ï¼Œéœ€åœ¨ Xcode ä¸­ Add Files to Targetã€‚
3. **UUID å¿…é¡» lowercased()**ï¼šä¼ ç»™åç«¯çš„æ‰€æœ‰ UUID å­—æ®µå¿…é¡»è°ƒç”¨ `.uuidString.lowercased()`ã€‚
